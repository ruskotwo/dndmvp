<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Master panel</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        #character-template, #item-template {
            display: none;
        }

        .form-control.is-invalid {
            padding-right: calc(1.2em);
            background-position: right calc(.1875rem) center;
            background-size: unset;
        }
    </style>
</head>
<body data-bs-theme="dark">

<div class="container text-center p-3">
    <div class="row">

        <div class="col-12 game-description mb-3">
            <div class="input-group mb-3">
                <span class="input-group-text" id="GameName">Game name</span>
                <input id="game-name" class="form-control" aria-label="GameName" aria-describedby="GameName">
            </div>
            <div class="input-group">
                <span class="input-group-text">Game description</span>
                <textarea id="game-description" class="form-control" aria-label="GameDescription" rows="8"></textarea>
            </div>
        </div>

        <div class="col-lg-9">
            <div id="character-row" class="row">

                <div id="character-template" class="col-md-4 character">
                    <div class="card mb-3">
                        <div class="card-body p-2">
                            <div class="input-group input-group-sm mb-2">
                                <span class="character-id input-group-text"></span>
                                <input class="character-name form-control" placeholder="Name">
                                <button class="character-delete btn btn-outline-danger" type="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
                                         class="bi bi-trash3" viewBox="0 0 16 16">
                                        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="input-group input-group-sm mb-2">
                                <input class="character-description form-control" placeholder="Description">
                            </div>
                            <div class="row">

                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">S</span>
                                        <input class="character-strength form-control" value="0">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">D</span>
                                        <input class="character-dexterity form-control" value="0">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">C</span>
                                        <input class="character-constitution form-control" value="0">
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">I</span>
                                        <input class="character-intelligence form-control" value="0">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">W</span>
                                        <input class="character-wisdom form-control" value="0">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">C</span>
                                        <input class="character-charisma form-control" value="0">
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">A</span>
                                        <input class="character-armor form-control" value="0">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">G</span>
                                        <input class="character-gold form-control" value="0">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">M</span>
                                        <input class="character-metaCoins form-control" value="0">
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">H</span>
                                        <input class="character-health form-control" value="0">
                                        <input class="character-healthDiff form-control" value="">
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="input-group input-group-sm">
                                        <textarea class="character-note form-control" rows="4"></textarea>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <button id="character-add" type="button" class="btn btn-outline-secondary w-100 h-100">
                        Add character
                    </button>
                </div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="item-row" class="row">

                <div id="item-template" class="col-12 item">
                    <div class="card mb-3">
                        <div class="card-body p-2">
                            <div class="input-group input-group-sm mb-2">
                                <span class="item-id input-group-text"></span>
                                <input class="item-name form-control" placeholder="Name">
                                <button class="item-delete btn btn-outline-danger" type="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
                                         class="bi bi-trash3" viewBox="0 0 16 16">
                                        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="input-group input-group-sm mb-2">
                                <input class="item-ownerId form-control" placeholder="Owner" value="0">
                                <input class="item-count form-control" placeholder="Count" value="1">
                            </div>
                            <div class="input-group input-group-sm mb-2">
                                <input class="item-description form-control" placeholder="Description">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <button id="item-add" type="button" class="btn btn-outline-secondary w-100 h-100">
                        Add item
                    </button>
                </div>

            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    window.addEventListener("load", function () {
        const gameId = 2; // TODO: Зашито
        const gamePass = localStorage.getItem('gamePass') ?? prompt('Write password');

        const characterTemplate = document.getElementById('character-template');
        const characterRow = document.getElementById('character-row');

        const itemTemplate = document.getElementById('item-template');
        const itemRow = document.getElementById('item-row');

        const characterInputs = {
            name: s => s.length < 255,
            description: s => s.length < 255,
            strength: s => /^-?\d{1,3}$/.test(s) && s > -128 && s < 127,
            dexterity: s => /^-?\d{1,3}$/.test(s) && s > -128 && s < 127,
            constitution: s => /^-?\d{1,3}$/.test(s) && s > -128 && s < 127,
            intelligence: s => /^-?\d{1,3}$/.test(s) && s > -128 && s < 127,
            wisdom: s => /^-?\d{1,3}$/.test(s) && s > -128 && s < 127,
            charisma: s => /^-?\d{1,3}$/.test(s) && s > -128 && s < 127,
            armor: s => /^\d{1,10}$/.test(s),
            gold: s => /^\d{1,10}$/.test(s),
            metaCoins: s => /^\d{1,10}$/.test(s),
            health: s => /^\d{1,10}$/.test(s),
        };

        const itemInputs = {
            name: s => s.length < 255,
            description: s => s.length < 65535,
            count: s => /^\d{1,10}$/.test(s),
            ownerId: s => /^\d{1,10}$/.test(s),
        };

        const gameInputs = {
            name: s => s.length < 255,
            description: s => s.length < 65535,
        };

        document.getElementById('character-add').addEventListener('click', () => {
            sendWS({type: 'createCharacter', data: gameId})
        });

        document.getElementById('item-add').addEventListener('click', () => {
            sendWS({type: 'createItem', data: gameId})
        });

        for (const input in gameInputs) {
            document.getElementById('game-' + input).addEventListener('input', event => {
                if (!gameInputs[input](event.target.value)) {
                    document.getElementById('game-' + input).classList.add('is-invalid')
                    return;
                }

                document.getElementById('game-' + input).classList.remove('is-invalid')

                sendWS({
                    type: 'updateGame',
                    data: {
                        id: gameId,
                        key: input,
                        value: event.target.value
                    }
                })
            })
        }

        let ws;

        function updateCharacter(data) {
            let character = document.getElementById('character-' + data.id);
            let isNew = false;

            if (!character) {
                character = addCharacter(data)
                isNew = true
            }

            character.getElementsByClassName('character-id')[0].innerHTML = data.id;

            let note = character.getElementsByClassName('character-note')[0];
            note.value = localStorage.getItem('character-note-' + data.id)

            for (const input in characterInputs) {
                const elem = character.getElementsByClassName('character-' + input)[0];

                elem.value = data[input];
                if (isNew) {
                    elem.addEventListener('input', event => {
                        if (!characterInputs[input](event.target.value)) {
                            elem.classList.add('is-invalid')
                            return;
                        }

                        elem.classList.remove('is-invalid')

                        sendWS({
                            type: 'updateCharacter',
                            data: {
                                id: data.id,
                                key: input,
                                value: event.target.value
                            }
                        })
                    })
                }
            }

            if (isNew) {
                character.getElementsByClassName('character-delete')[0].addEventListener('click', () => {
                    if (confirm('Confirm delete? ')) {
                        sendWS({
                            type: 'deleteCharacter',
                            data: data.id
                        })
                    }
                });
                note.addEventListener('change', event => {
                    localStorage.setItem('character-note-' + data.id, event.target.value)
                });
            }
        }

        function addCharacter(data = {}) {
            let newCharacter = document.createElement('div');

            newCharacter.classList.add('col-md-4');
            newCharacter.innerHTML = characterTemplate.innerHTML;
            newCharacter.id = 'character-' + data.id;

            return characterRow.insertBefore(newCharacter, characterTemplate);
        }

        function updateItem(data) {
            let item = document.getElementById('item-' + data.id);
            let isNew = false;

            if (!item) {
                item = addItem(data)
                isNew = true;
            }

            item.getElementsByClassName('item-id')[0].innerHTML = data.id;

            for (const input in itemInputs) {
                const elem = item.getElementsByClassName('item-' + input)[0];

                elem.value = data[input];
                if (isNew) {
                    elem.addEventListener('input', event => {
                        if (!itemInputs[input](event.target.value)) {
                            elem.classList.add('is-invalid')
                            return;
                        }

                        elem.classList.remove('is-invalid')

                        sendWS({
                            type: 'updateItem',
                            data: {
                                id: data.id,
                                key: input,
                                value: event.target.value
                            }
                        })
                    })
                }
            }

            if (isNew) {
                item.getElementsByClassName('item-delete')[0].addEventListener('click', () => {
                    if (confirm('Confirm delete? ')) {
                        sendWS({
                            type: 'deleteItem',
                            data: data.id
                        })
                    }
                });
            }
        }

        function addItem(data = {}) {
            let newItem = document.createElement('div');

            newItem.classList.add('col-12');
            newItem.innerHTML = itemTemplate.innerHTML;
            newItem.id = 'item-' + data.id;

            return itemRow.insertBefore(newItem, itemTemplate);
        }

        function initWS() {
            if (ws) {
                return;
            }

            ws = new WebSocket('ws://' + window.location.host + '/ws/master?pass=' + gamePass);

            ws.onopen = function () {
                console.log('Open');
                localStorage.setItem('gamePass', gamePass)
            }
            ws.onclose = function () {
                console.log('Close');
                ws = null
                setTimeout(() => initWS(), 10000)
            }
            ws.onmessage = function (raw) {
                let evt = JSON.parse(raw.data)
                console.log(evt)

                switch (evt.type) {
                    case 'allData':
                        for (const input in gameInputs) {
                            document.getElementById('game-' + input).value = evt.data.game[input] ?? '';
                        }

                        for (const character of evt.data.characters ?? []) {
                            updateCharacter(character)
                        }

                        for (const item of evt.data.items ?? []) {
                            updateItem(item)
                        }
                        return;
                    case 'createCharacter':
                        updateCharacter(evt.data)
                        return;
                    case 'deleteCharacter':
                        document.getElementById('character-' + evt.data).remove()
                        return;
                    case 'createItem':
                        updateItem(evt.data)
                        return;
                    case 'deleteItem':
                        document.getElementById('item-' + evt.data).remove()
                        return;
                }
            }
            ws.onerror = function (evt) {
                console.log('Error: ', evt);
            }
        }

        function sendWS(data) {
            if (!ws) {
                initWS()
            }

            if (!ws) {
                console.error('ws not inited')
                return
            }

            ws.send(JSON.stringify(data))
        }

        initWS()
    });
</script>
</body>
</html>